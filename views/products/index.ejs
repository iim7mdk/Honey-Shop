<% layout('/layouts/boilerplate') %>

  <link rel="stylesheet" href="/stylesheets/stars.css">

  <div class="container py-5" dir="rtl">
    <!-- العنوان وزر الإضافة -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <h1 class="display-5 fw-bold" style="color:#b7791f;">منتجات العسل</h1>
      <a href="/products/new" class="btn btn-warning text-white shadow-sm">
        <!-- <i class="bi bi-plus-circle"></i> -->
         إضافة منتج جديد
      </a>
    </div>

    <!-- نموذج البحث -->
    <form class="mb-4 bg-light p-4 rounded-4 shadow-sm" method="GET" action="/products" id="categoryFilterForm">
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label fw-semibold" for="searchInput">ابحث</label>
          <input type="text" class="form-control" name="search" id="searchInput" placeholder="ابحث عن نوع العسل..."
            value="<%= typeof search !== 'undefined' ? search : '' %>">
        </div>

        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-warning text-white w-100">بحث</button>
        </div>
      </div>
    </form>

    <!-- زر مسح الفلاتر -->
    <% if (category || search) { %>
      <a href="/products" class="btn btn-outline-secondary mb-4">إلغاء الفلاتر</a>
      <% } %>

        <!-- كروت المنتجات -->
        <% if (products.length> 0) { %>
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <% for (let product of products) { %>
              <div class="col">
                <div class="card h-100 border-0 rounded-4 shadow-sm overflow-hidden">
                  <a href="/products/<%= product._id %>" class="text-decoration-none text-dark">
                    <% if (product.images.length) { %>
                      <img class="card-img-top" src="<%= product.images[0].url %>" alt="<%= product.title %>">
                      <% } else { %>
                        <img src="https://via.placeholder.com/400x300?text=No+Image" class="card-img-top"
                          alt="No image">
                        <% } %>

                          <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-2 fw-bold" style="color:#5a3e2b;">
                              <%= product.title %>
                                <span class="float-end text-warning fw-semibold">
                                  <%= product.price %> ر.ي
                                </span>
                            </h5>

                            <% let total=0; let count=product.reviews.length; for (let review of product.reviews) {
                              total +=review.rating; } let avgRating=count ? total / count : 0; %>

                              <% if (count !==0) { %>
                                <p class="starability-result mb-2" data-rating="<%= avgRating %>">
                                  التقييم: <%= avgRating.toFixed(1) %> / 5
                                </p>
                                <% } %>

                                  <p class="text-muted mb-1">التصنيف: <%= product.category %>
                                  </p>
                                  <p class="card-text">
                                    <%= product.description.substring(0, 100) %>...
                                  </p>
                          </div>
                  </a>

                  <div class="px-3 pb-3 mt-auto">
                    <a href="/products/<%= product._id %>" class="btn btn-outline-warning w-100 shadow-sm">عرض
                      التفاصيل</a>
                  </div>
                </div>
              </div>
              <% } %>
          </div>
          <% } else { %>
            <div class="text-center text-muted my-5">
              <h4>لا توجد منتجات حاليًا</h4>
            </div>
            <% } %>
  </div>

  <!-- سكربت البحث التلقائي -->
  <script>
    const searchInput = document.getElementById('searchInput');
    let timeout = null;
    searchInput.addEventListener('input', function () {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        document.getElementById('categoryFilterForm').submit();
      }, 1000);
    });
  </script>